<!DOCTYPE html>
<html lang="en">
<head>
	<style>
	/* 隐藏水平滚动条 */
	body {
		overflow-x: hidden;
	}

	/* 隐藏垂直滚动条 */
	body {
		overflow-y: hidden;
	}
	</style>

	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>高级日志分析工具 - 关键词颜色高亮</title>
	<script src="https://cdn.tailwindcss.com"></script>
	<link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">

	<script>
		tailwind.config = {
			theme: {
				extend: {
					colors: {
						primary: '#165DFF',
						secondary: '#0e42c7',
						neutral: '#86909C',
						dark: '#1d2129'
					},
					fontFamily: {
						mono: ['Consolas', 'Monaco', 'monospace']
					}
				}
			}
		}
	</script>

	<style type="text/tailwindcss">
		@layer utilities {
			.log-container {
				height: calc(100vh - 185px); /* 增加高度适应新UI */
				overflow-y: auto;
			}
			.horizontal-scrollbar {
				position: sticky;
				bottom: 0;
				z-index: 10;
				background-color: white;
				border-top: 1px solid #eee;
			}
			.sync-scroll {
				scrollbar-width: thin;
			}
			.key-hint {
				@apply inline-block bg-gray-100 text-gray-700 text-xs px-1.5 py-0.5 rounded mx-0.5;
			}
			/* 高亮颜色定义 */
			.highlight-0 { @apply bg-yellow-200 text-gray-800; }
			.highlight-1 { @apply bg-blue-200 text-gray-800; }
			.highlight-2 { @apply bg-green-200 text-gray-800; }
			.highlight-3 { @apply bg-pink-200 text-gray-800; }
			.highlight-4 { @apply bg-purple-200 text-gray-800; }
			.highlight-5 { @apply bg-orange-200 text-gray-800; }
			.highlight-6 { @apply bg-cyan-200 text-gray-800; }
			.highlight-7 { @apply bg-red-200 text-gray-800; }
			.highlight-8 { @apply bg-lime-200 text-gray-800; }
			.highlight-9 { @apply bg-amber-200 text-gray-800; }
		}
	</style>
</head>
<body class="bg-gray-50 m-0 p-0 font-sans">
	<!-- 顶部导航 -->
	<header class="bg-gradient-to-r from-primary to-secondary shadow-xs p-3">
		<div class="flex justify-between items-center">
			<div class="flex items-center">
				<i class="fa fa-file-text-o text-white mr-2 text-xl"></i>
				<h1 class="text-xl font-bold text-white">高级电源日志分析工具(如遇到问题找冉雪峰 11143232)</h1>
			</div>
			<div class="flex gap-2">
				<button id="uploadBtn" class="bg-white text-primary px-4 py-2 rounded-lg text-sm flex items-center font-medium hover:bg-gray-50 transition">
					<i class="fa fa-upload mr-2"></i>导入日志
				</button>
				<button id="copyBtn" class="bg-white text-gray-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-50 transition flex items-center">
					<i class="fa fa-copy mr-2"></i>复制
				</button>
			</div>
		</div>
	</header>

	<!-- 搜索和快捷键提示区域 -->
	<div class="bg-white border-b border-gray-100 p-4">
		<div class="flex flex-wrap items-center gap-4">
			<!-- 搜索框区域（保持不变） -->
			<div class="relative flex-1 min-w-[300px] max-w-3xl">
				<div class="flex items-center gap-2 mb-2">
					<i class="fa fa-search text-neutral"></i>
					<input type="text" id="searchInput" placeholder="搜索日志内容（支持空格分隔多关键词）..."
						   class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent text-base">
					<button id="clearSearch" class="text-neutral hover:text-gray-700 transition hidden">
						<i class="fa fa-times-circle text-lg"></i>
					</button>
				</div>

				<!-- 关键词颜色图例 -->
				<div id="keywordLegend" class="flex flex-wrap gap-2 mt-2 hidden">
					<span class="text-xs text-gray-600">关键词颜色:</span>
				</div>
			</div>

			<!-- 修改后的选项和快捷键区域 -->
			<div class="flex items-start gap-4">
				<!-- 选项区域 - 改为水平排列 -->
				<div class="flex gap-4 text-sm bg-gray-50 p-3 rounded-lg border border-gray-200 border-[0.5px]">
					<label class="flex items-center text-gray-700 cursor-pointer whitespace-nowrap">
						<input type="checkbox" id="regexCheckbox" class="mr-2 h-4 w-4 text-primary rounded focus:ring-primary">
						正则表达式
					</label>
					<label class="flex items-center text-gray-700 cursor-pointer whitespace-nowrap">
						<input type="checkbox" id="ignoreCaseCheckbox" class="mr-2 h-4 w-4 text-primary rounded focus:ring-primary" checked>
						忽略大小写
					</label>
					<div id="searchError" class="flex items-center text-red-500 text-sm hidden ml-2">
						<i class="fa fa-exclamation-triangle mr-1"></i><span></span>
					</div>
				</div>

				<!-- 快捷键提示区域 -->
				<div class="text-sm bg-gray-50 p-3 rounded-lg border border-gray-200 border-[0.5px]">
					<div class="flex flex-wrap gap-2 text-xs">
						<div class="flex items-center">
							<span class="key-hint">←</span>
							<span class="text-gray-600 ml-1">向左滚动</span>
						</div>
						<div class="flex items-center">
							<span class="key-hint">→</span>
							<span class="text-gray-600 ml-1">向右滚动</span>
						</div>
						<div class="flex items-center">
							<span class="key-hint">Shift+←</span>
							<span class="text-gray-600 ml-1">快速左滚</span>
						</div>
						<div class="flex items-center">
							<span class="key-hint">Shift+→</span>
							<span class="text-gray-600 ml-1">快速右滚</span>
						</div>
						<div class="flex items-center">
							<span class="key-hint">F</span>
							<span class="text-gray-600 ml-1">聚焦搜索框</span>
						</div>
						<div class="flex items-center">
							<span class="key-hint">Esc</span>
							<span class="text-gray-600 ml-1">清除搜索</span>
						</div>
					</div>
				</div>
			</div>

			<!-- 计数区域 -->
			<div class="ml-auto text-sm text-gray-700 bg-gray-50 px-3 py-2 rounded-lg border border-gray-200 border-[0.5px]">
				<div class="flex items-center">
					<span id="matchCount" class="font-medium">0 条匹配</span>
					<span class="mx-2 text-gray-400">|</span>
					<span id="totalCount" class="font-medium">共 0 条</span>
				</div>
			</div>
		</div>
	</div>

	<!-- 日志内容区域 -->
	<div class="p-4">
		<!-- 日志显示容器 -->
		<div class="border border-gray-200 border-t-0 rounded-b-lg bg-white shadow-sm">
			<!-- 日志文本区域 - 纵向滚动 -->
			<div id="logContent" class="log-container font-mono text-sm">
				<div id="logLines" class="divide-y divide-gray-100">
					<!-- 日志内容将通过JS填充 -->
				</div>
			</div>

			<!-- 横向滚动条 - 固定在底部，与内容同步滚动 -->
			<div class="horizontal-scrollbar">
				<div id="syncScroll" class="sync-scroll h-3">
					<div id="scrollProxy" class="h-3"></div>
				</div>
			</div>
		</div>
	</div>

	<script>
		//LOGENGIN_INIT_DATA

		// DOM元素
		const logLinesEl = document.getElementById('logLines');
		const logContentEl = document.getElementById('logContent');
		const syncScrollEl = document.getElementById('syncScroll');
		const scrollProxyEl = document.getElementById('scrollProxy');
		const searchInputEl = document.getElementById('searchInput');
		const clearSearchEl = document.getElementById('clearSearch');
		const matchCountEl = document.getElementById('matchCount');
		const totalCountEl = document.getElementById('totalCount');
		const uploadBtnEl = document.getElementById('uploadBtn');
		const copyBtnEl = document.getElementById('copyBtn');
		const regexCheckbox = document.getElementById('regexCheckbox');
		const ignoreCaseCheckbox = document.getElementById('ignoreCaseCheckbox');
		const searchErrorEl = document.getElementById('searchError');
		const keywordLegendEl = document.getElementById('keywordLegend');

		// 滚动配置
		const SCROLL_SPEED = 50;	   // 普通滚动速度
		const FAST_SCROLL_SPEED = 200; // 快速滚动速度（Shift+方向键）

		// 当前日志数据
		let currentLogs = [...logData];
		// 高亮颜色池
		const highlightColors = [
			'highlight-0', // 黄色
			'highlight-1', // 蓝色
			'highlight-2', // 绿色
			'highlight-3', // 粉色
			'highlight-4', // 紫色
			'highlight-5', // 橙色
			'highlight-6', // 青色
			'highlight-7', // 红色
			'highlight-8', // 青柠色
			'highlight-9'  // 琥珀色
		];
		// 关键词到颜色的映射
		let keywordColorMap = {};

		// 初始化
		function init() {
			renderLogs(currentLogs);
			setupScrollSync();
			setupEventListeners();
			setupKeyboardNavigation();
			updateCounters(currentLogs.length, 0);
		}

		// 渲染日志
		function renderLogs(logs) {
			logLinesEl.innerHTML = '';

			logs.forEach((log, index) => {
				const lineEl = document.createElement('div');
				lineEl.className = 'flex py-2 px-4 hover:bg-gray-50 transition-colors';

				// 行号
				const lineNum = document.createElement('span');
				lineNum.className = 'text-neutral w-10 text-right pr-3 border-r border-gray-100 mr-3 select-none';
				lineNum.textContent = index + 1;

				// 日志文本
				const logText = document.createElement('span');
				logText.className = 'whitespace-nowrap';
				logText.textContent = log;

				lineEl.appendChild(lineNum);
				lineEl.appendChild(logText);
				logLinesEl.appendChild(lineEl);
			});

			// 更新滚动代理宽度以匹配内容宽度
			scrollProxyEl.style.width = `${logLinesEl.scrollWidth}px`;
		}

		// 设置滚动同步 - 横向滚动条与内容同步
		function setupScrollSync() {
			// 当内容横向滚动时，同步滚动条位置
			logContentEl.addEventListener('scroll', (e) => {
				syncScrollEl.scrollLeft = e.target.scrollLeft;
			});

			// 当滚动条滚动时，同步内容位置
			syncScrollEl.addEventListener('scroll', (e) => {
				logContentEl.scrollLeft = e.target.scrollLeft;
			});
		}

		// 设置键盘导航 - 左右方向键控制横向滚动
		function setupKeyboardNavigation() {
			document.addEventListener('keydown', (e) => {
				// 如果搜索框聚焦，则不处理滚动（避免影响输入）
				if (document.activeElement === searchInputEl) {
					// 支持Esc清除搜索
					if (e.key === 'Escape') {
						clearSearch();
					}
					return;
				}

				// F键聚焦搜索框
				if (e.key === 'f' || e.key === 'F') {
					// 检查是否按下了Ctrl键
					if (e.ctrlKey || e.metaKey) {
						// 如果是Ctrl+F，则允许浏览器默认行为
						return;
					}
					e.preventDefault();
					searchInputEl.focus();
					searchInputEl.select();
					searchBoxEl.classList.add('focused');
					showToast('已聚焦搜索框 - 按Enter搜索');
					return;
				}

				// 支持Esc清除搜索
				if (e.key === 'Escape') {
					clearSearch();
					return;
				}

				const isShiftPressed = e.shiftKey;
				const scrollAmount = isShiftPressed ? FAST_SCROLL_SPEED : SCROLL_SPEED;

				// 左方向键 - 向左滚动
				if (e.key === 'ArrowLeft') {
					e.preventDefault(); // 阻止页面默认滚动行为
					const newScrollLeft = logContentEl.scrollLeft - scrollAmount;
					logContentEl.scrollLeft = Math.max(0, newScrollLeft);
				}

				// 右方向键 - 向右滚动
				if (e.key === 'ArrowRight') {
					e.preventDefault(); // 阻止页面默认滚动行为
					const maxScroll = logLinesEl.scrollWidth - logContentEl.clientWidth;
					const newScrollLeft = logContentEl.scrollLeft + scrollAmount;
					logContentEl.scrollLeft = Math.min(maxScroll, newScrollLeft);
				}
			});
		}

		// 设置事件监听
		function setupEventListeners() {
			// 搜索功能

			// 添加 Enter 键事件监听
			searchInputEl.addEventListener('keydown', function(e) {
				if (e.key === 'Enter' || e.keyCode === 13) {
					handleSearch(); // 仅在按下 Enter 时触发搜索
				}
			});

			clearSearchEl.addEventListener('click', clearSearch);

			// 正则和忽略大小写设置改变时重新搜索
			regexCheckbox.addEventListener('change', handleSearch);
			ignoreCaseCheckbox.addEventListener('change', handleSearch);

			// 上传日志
			uploadBtnEl.addEventListener('click', () => {
				const fileInput = document.createElement('input');
				fileInput.type = 'file';

				fileInput.setAttribute('data-allow-no-extension', 'true');
				fileInput.onchange = handleFileUpload;
				fileInput.click();
			});

			// 复制日志
			copyBtnEl.addEventListener('click', copyLogs);
		}

		// 处理搜索
		function handleSearch() {
			const searchTerm = searchInputEl.value.trim();
			const isRegex = regexCheckbox.checked;
			const ignoreCase = ignoreCaseCheckbox.checked;

			// 清除之前的错误提示
			searchErrorEl.classList.add('hidden');
			searchInputEl.classList.remove('border-red-500');

			// 显示/隐藏清除按钮
			clearSearchEl.style.display = searchTerm ? 'block' : 'none';

			if (!searchTerm) {
				// 无搜索词，显示所有日志
				renderLogs(currentLogs);
				updateCounters(currentLogs.length, 0);
				keywordLegendEl.classList.add('hidden');
				return;
			}

			try {
				// 重置关键词颜色映射
				keywordColorMap = {};

				// 过滤日志
				let filteredLogs;
				if (isRegex) {
					// 正则模式 - 整个正则作为一个"关键词"
					const regex = new RegExp(searchTerm, ignoreCase ? 'gi' : 'g');
					filteredLogs = currentLogs.filter(log => regex.test(log));

					// 为整个正则分配一个颜色
					keywordColorMap[searchTerm] = highlightColors[0];
					updateKeywordLegend();
				} else {
					// 普通模式 - 支持多个关键词（空格分隔）
					const keywords = searchTerm.split(/\s+/).filter(k => k.length > 0);

					if (keywords.length === 0) {
						filteredLogs = currentLogs;
					} else {
						// 为每个关键词分配颜色
						keywords.forEach((keyword, index) => {
							const normalizedKeyword = ignoreCase ? keyword.toLowerCase() : keyword;
							keywordColorMap[normalizedKeyword] = highlightColors[index % highlightColors.length];
						});

						updateKeywordLegend();

						// 创建正则表达式匹配所有关键词
						const regex = new RegExp(
							keywords.map(k => escapeRegExp(k)).join('|'),
							ignoreCase ? 'gi' : 'g'
						);

						filteredLogs = currentLogs.filter(log => regex.test(log));
					}
				}

				renderLogs(filteredLogs);
				updateCounters(currentLogs.length, filteredLogs.length);
				highlightMatches(searchTerm, isRegex, ignoreCase);
			} catch (e) {
				// 处理正则表达式错误
				searchErrorEl.querySelector('span').textContent = e.message;
				searchErrorEl.classList.remove('hidden');
				searchInputEl.classList.add('border-red-500');
				keywordLegendEl.classList.add('hidden');
			}
		}

		// 更新关键词颜色图例
		function updateKeywordLegend() {
			keywordLegendEl.innerHTML = '<span class="text-xs text-gray-600">关键词颜色:</span>';

			Object.entries(keywordColorMap).forEach(([keyword, colorClass]) => {
				const legendItem = document.createElement('div');
				legendItem.className = `flex items-center text-xs ml-2`;

				const colorBox = document.createElement('span');
				colorBox.className = `inline-block w-3 h-3 rounded-full mr-1 ${colorClass}`;

				const keywordText = document.createElement('span');
				keywordText.className = 'text-gray-700';
				keywordText.textContent = keyword.length > 10 ? `${keyword.substring(0, 8)}...` : keyword;

				legendItem.appendChild(colorBox);
				legendItem.appendChild(keywordText);
				keywordLegendEl.appendChild(legendItem);
			});

			keywordLegendEl.classList.remove('hidden');
		}

		// 清除搜索
		function clearSearch() {
			searchInputEl.value = '';
			clearSearchEl.style.display = 'none';
			searchErrorEl.classList.add('hidden');
			searchInputEl.classList.remove('border-red-500');
			keywordLegendEl.classList.add('hidden');
			renderLogs(currentLogs);
			updateCounters(currentLogs.length, 0);
		}

		// 高亮匹配内容（确保相同关键词使用相同颜色）
		function highlightMatches(term, isRegex, ignoreCase) {
			const logTexts = logLinesEl.querySelectorAll('span:last-child');

			logTexts.forEach(textEl => {
				const text = textEl.textContent;
				let html = '';
				let lastIndex = 0;
				let match;

				try {
					if (isRegex) {
						// 正则模式 - 整个正则作为一个"关键词"
						const regex = new RegExp(term, ignoreCase ? 'gi' : 'g');
						const colorClass = keywordColorMap[term];

						while ((match = regex.exec(text)) !== null) {
							// 匹配之前的文本
							const before = text.substring(lastIndex, match.index);
							// 匹配的文本
							const matchedText = match[0];

							// 添加到HTML
							html += before + `<span class="${colorClass} px-0.5 rounded">${matchedText}</span>`;

							// 更新最后索引
							lastIndex = match.index + matchedText.length;

							// 避免零长度匹配导致无限循环
							if (match.index === regex.lastIndex) {
								regex.lastIndex++;
							}
						}
					} else {
						// 普通模式 - 支持多个关键词
						const keywords = term.split(/\s+/).filter(k => k.length > 0);

						if (keywords.length > 0) {
							// 创建正则表达式匹配所有关键词
							const regex = new RegExp(
								keywords.map(k => escapeRegExp(k)).join('|'),
								ignoreCase ? 'gi' : 'g'
							);

							while ((match = regex.exec(text)) !== null) {
								// 匹配之前的文本
								const before = text.substring(lastIndex, match.index);
								// 匹配的文本
								const matchedText = match[0];
								// 获取关键词对应的颜色
								const keyword = ignoreCase ? matchedText.toLowerCase() : matchedText;
								const colorClass = Object.entries(keywordColorMap).find(
									([k]) => ignoreCase
										? keyword.includes(k.toLowerCase())
										: keyword.includes(k)
								)?.[1] || highlightColors[0];

								// 添加到HTML
								html += before + `<span class="${colorClass} px-0.5 rounded">${matchedText}</span>`;

								// 更新最后索引
								lastIndex = match.index + matchedText.length;

								// 避免零长度匹配导致无限循环
								if (match.index === regex.lastIndex) {
									regex.lastIndex++;
								}
							}
						}
					}

					// 添加剩余文本
					html += text.substring(lastIndex);
					textEl.innerHTML = html;
				} catch (e) {
					// 出错时恢复原始文本
					textEl.textContent = text;
				}
			});
		}

		// 转义正则表达式特殊字符
		function escapeRegExp(string) {
			return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
		}

		// 更新计数器
		function updateCounters(total, matches) {
			totalCountEl.textContent = `共 ${total} 条`;
			matchCountEl.textContent = `${matches} 条匹配`;
		}

		// 处理文件上传
		function handleFileUpload(e) {
			const file = e.target.files[0];
			if (!file) return;

			const reader = new FileReader();
			reader.onload = (event) => {
				const content = event.target.result;
				currentLogs = content.split('\n').filter(line => line.trim());
				renderLogs(currentLogs);
				clearSearch();
				updateCounters(currentLogs.length, 0);
			};
			reader.readAsText(file);
		}

		// 复制日志
		function copyLogs() {
			const textToCopy = currentLogs.join('\n');
			navigator.clipboard.writeText(textToCopy)
				.then(() => {
					showToast('日志已复制到剪贴板');
				})
				.catch(() => {
					showToast('复制失败，请手动复制', 'error');
				});
		}

		// 显示提示消息
		function showToast(message, type = 'success') {
			const toast = document.createElement('div');
			toast.className = `fixed bottom-4 right-4 px-4 py-2 rounded-lg shadow-lg text-sm transition-all duration-300 transform translate-y-10 opacity-0 flex items-center`;

			if (type === 'success') {
				toast.classList.add('bg-green-50', 'text-green-700', 'border', 'border-green-200');
				toast.innerHTML = `<i class="fa fa-check-circle mr-2"></i> ${message}`;
			} else {
				toast.classList.add('bg-red-50', 'text-red-700', 'border', 'border-red-200');
				toast.innerHTML = `<i class="fa fa-exclamation-circle mr-2"></i> ${message}`;
			}

			document.body.appendChild(toast);

			// 显示
			setTimeout(() => {
				toast.classList.remove('translate-y-10', 'opacity-0');
				toast.classList.add('translate-y-0', 'opacity-100');
			}, 10);

			// 隐藏
			setTimeout(() => {
				toast.classList.remove('translate-y-0', 'opacity-100');
				toast.classList.add('translate-y-10', 'opacity-0');
				setTimeout(() => toast.remove(), 300);
			}, 2000);
		}

		// 页面加载完成后初始化
		document.addEventListener('DOMContentLoaded', init);
	</script>
</body>
</html>
